# Security Invariants

> **事故防止の絶対ルール**。これらは仕様変更があっても優先される制約。  
> 競合時の優先順位において例外なく強制。

## 認証・認可（サーバ強制）

1. **admin 以外は `/admin/*` を 403**
   - UI で隠すだけでは不可（サーバ側で強制）
   - logs / settings（AIモデル変更）は admin のみ

2. **所有権チェック必須**
   - 他ユーザーのデータにはアクセス不可
   - Observation / Tag は所有者のみ操作可

## 秘匿情報の保護

1. **ログ出力禁止**
   - APIキー / トークン / 個人情報をログに出さない
   - 本番ログに画像データ（base64）を含めない
   - AI のフルレスポンスは出さない（サマリのみ可）

2. **画面出力禁止**
   - 秘匿情報を UI に表示しない
   - エラーメッセージに内部情報を含めない

3. **クライアント露出禁止**
   - API キー（Gemini、Vision）はサーバ側のみ
   - フロントエンドから直接 AI API を呼ばない

4. **Git コミット禁止**
   - `.env`、`service-account.json` 等はコミットしない
   - `.gitignore` で除外を確認

## AI モデル制御

1. **allowlist 外モデルは必ず拒否**
   - サーバ側で強制（UIで選択肢を隠すだけでは不可）
   - allowlist は `docs/ai-models.md` を参照

2. **不適切コンテンツのブロック**
   - Gemini の安全設定を有効化
   - 検出時は安全なフォールバックメッセージを返す

## アップロード検証

1. **MIME + 実体検証**
   - Content-Type だけでなく、ファイルヘッダ（マジックバイト）も確認

2. **レート制限 (throttle)**
   - アップロードにはレートリミット必須

## プライバシー

1. **GPS のみ抽出可**
   - 位置情報は緯度・経度のみ保存可（マップ機能用）
   - その他の EXIF メタデータは削除すること

---

*Last updated: 2026-01-22*
